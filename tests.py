import tensorflow as tf
import tensorflow.keras as keras
import numpy as np
from deployMNIST.settings import ML_MODELS_DIR
import requests


test_case = np.array([[0.        , 0.        , 0.        , 0.        , 0.        ,

            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.45490196, 0.49019608, 0.67058824, 1.        , 1.        ,
            0.58823529, 0.36470588, 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.6627451 ,
            0.99215686, 0.99215686, 0.99215686, 0.99215686, 0.99215686,
            0.99215686, 0.85490196, 0.11764706, 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.6627451 , 0.99215686,
            0.99215686, 0.99215686, 0.83529412, 0.55686275, 0.69019608,
            0.99215686, 0.99215686, 0.47843137, 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.20392157, 0.98039216, 0.99215686,
            0.82352941, 0.1254902 , 0.04705882, 0.        , 0.02352941,
            0.80784314, 0.99215686, 0.54901961, 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.30196078, 0.98431373, 0.82352941,
            0.09803922, 0.        , 0.        , 0.        , 0.47843137,
            0.97254902, 0.99215686, 0.25490196, 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.12156863, 0.07058824,
            0.        , 0.        , 0.        , 0.        , 0.81960784,
            0.99215686, 0.99215686, 0.25490196, 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.45882353, 0.96862745,
            0.99215686, 0.77647059, 0.03921569, 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.29803922, 0.96862745, 0.99215686,
            0.90588235, 0.24705882, 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.50196078, 0.99215686, 0.99215686,
            0.56470588, 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.69019608, 0.96470588, 0.99215686, 0.62352941,
            0.04705882, 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.09803922, 0.91764706, 0.99215686, 0.91372549, 0.1372549 ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.77647059, 0.99215686, 0.99215686, 0.55294118, 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.30588235,
            0.97254902, 0.99215686, 0.74117647, 0.04705882, 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.0745098 , 0.78431373,
            0.99215686, 0.99215686, 0.55294118, 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.5254902 , 0.99215686,
            0.99215686, 0.67843137, 0.04705882, 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.97254902, 0.99215686,
            0.99215686, 0.09803922, 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.97254902, 0.99215686,
            0.99215686, 0.16862745, 0.07843137, 0.07843137, 0.07843137,
            0.07843137, 0.01960784, 0.        , 0.01960784, 0.07843137,
            0.07843137, 0.14509804, 0.58823529, 0.58823529, 0.58823529,
            0.57647059, 0.03921569, 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.97254902, 0.99215686,
            0.99215686, 0.99215686, 0.99215686, 0.99215686, 0.99215686,
            0.99215686, 0.65882353, 0.56078431, 0.65098039, 0.99215686,
            0.99215686, 0.99215686, 0.99215686, 0.99215686, 0.99215686,
            0.99215686, 0.48235294, 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.68235294, 0.99215686,
            0.99215686, 0.99215686, 0.99215686, 0.99215686, 0.99215686,
            0.99215686, 0.99215686, 0.99215686, 0.99215686, 0.99215686,
            0.97647059, 0.96862745, 0.96862745, 0.6627451 , 0.45882353,
            0.45882353, 0.22352941, 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.4627451 ,
            0.48235294, 0.48235294, 0.48235294, 0.65098039, 0.99215686,
            0.99215686, 0.99215686, 0.60784314, 0.48235294, 0.48235294,
            0.16078431, 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ],
        [0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        , 0.        , 0.        ,
            0.        , 0.        , 0.        ]])


def check_model_loading():
    path = f'{ML_MODELS_DIR}/first_MNIST_model'
    loaded_model = keras.models.load_model(path)

    x_ready_for_model = test_case.reshape((1, test_case.shape[0], test_case.shape[0]))

    print('Model Prediction is: ', np.argmax(loaded_model.predict(x_ready_for_model)))

def test_reshape():
    print(test_case.shape)
    reshaped = test_case.reshape((1, test_case.shape[0], test_case.shape[0]))
    print(reshaped.shape)

def test_endpoint():
    pixel_array = test_case.tolist()
    url = 'http://127.0.0.1:8000/api/prediction'
    response = requests.post(url, json=pixel_array)
    print(response.content)